# Pentesting (kali)

## Installation

Kali [installation per netinstaller iso](https://www.kali.org/downloads/) in [KVM](Installation-kvm.md) went without a glitch.

## Security notes

When installing kali in a virtual machine from a premade image, there are several components that are not installed, outdated or set with insecure default settings like [default credentials](https://www.kali.org/docs/introduction/default-credentials/). This is true to a lesser extent for the `.iso`'s also. All machines have several same settings by default like the same outdated SSH keys etcetera. A sword of Damocles ...

## Update and upgrade

Offensive Security make these files every few months or so. Kali is outdated (read "vulnerable") when it is installed. 

Update and upgrade immediately. And `apt dist-upgrade`.

    $ sudo apt update
    $ sudo apt upgrade
    $ sudo apt dist-upgrade

## New SSH keys

Everyone who downloaded and installed the same image have the same [SSH keys](../ssh.md). Create a new pair.

Create a folder `old_keys` in the `/etc/ssh` directory and move the old keys into that folder.

    $ sudo mkdir /etc/ssh/old_keys
    $ sudo mv ssh_host_* /etc/ssh/old_keys

Check with:

    $ ls /etc/ssh/old_keys

Create new pair:

    $ sudo dpkg-reconfigure openssh-server

Ignore warning message or a message about a static unit. 

Check the MD5 hashes of the new keys and compare them to the default ones moved into `old_keys`.

    $ md5sum /etc/ssh/ssh_host_*

and

    $ md5sum /etc/ssh/old_keys/ssh_host_*

If different, new SSH keys have been created.

## Firefox plugins

NoScript, Privacy badger, HTTPS everywhere, uBlock origin, user-agent switcher.

## Keybase

We use keybase for collaborative reporting. I'd rather not move files through the host.

    $ curl -O https://prerelease.keybase.io/keybase_amd64.deb

    $ sudo dpkg -i keybase_amd64.deb

It gives errors about missing `libappindicator1` (allow applications to export a menu into the panel) and `libgconf-2-4`. The latter can be installed from the repository. The first not. So, remove with:

    $ sudo apt-get install -f

This will propose to remove keybase to solve the conflict. Add `libgconf-2-4`:

    $ sudo apt install libgconf-2-4

Try again:

    $ sudo dpkg -i keybase_amd64.deb

Keybase is installed, but not configured and will not run as `root`. 

### Solution 1: Create a wrapper

Create a user for keybase:

    $ sudo adduser keybase

Using the cli version of keybase can be done with

    $ su - keybase

And for the GUI create a wrapper in `/usr/local/bin/run_keybase.sh`

    $ sudo vi run_keybase.sh

Content:

    #!/bin/bash
    xhost +SI:localuser:keybase
    su - keybase -c "/usr/bin/run_keybase"

Change permissions: 

    $ sudo chmod 0755 /usr/local/bin/run_keybase.sh

Test it with:

    $ ./run_keybase.sh

Change desktop icons:

    $ sudo vi /usr/share/applications/keybase.desktop

From

    Exec=run_keybase

To 

    Exec=/usr/local/bin/run_keybase.sh

Restart machine. Ok. Worked, but didn't work. Try something else.

### Solution 2: Find a way to install libappindicator1

    $ curl -p --insecure "http://ftp.br.debian.org/debian/pool/main/liba/libappindicator/libappindicator1_0.4.92-8_amd64.deb" --output libappindicator1_0.4.92-8_amd64.deb
    $ curl -p --insecure "http://ftp.br.debian.org/debian/pool/main/libi/libindicator/libindicator7_0.5.0-4_amd64.deb" --output libindicator7_0.5.0-4_amd64.deb

    $ sudo dpkg --install libindicator7_0.5.0-4_amd64.deb
    $ sudo apt-get install libdbusmenu-gtk4
    $ sudo dpkg --install libappindicator1_0.4.92-8_amd64.deb

    $ sudo apt install ./keybase_amd64.deb
    $ run_keybase

Done. Works like a charm. Version numbers may change in time.

* https://pkgs.org/download/libappindicator1 
* https://pkgs.org/download/libindicator7

